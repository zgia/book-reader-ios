<!-- Generated by SpecStory -->

<!-- cursor Session cbe2f723-8ba2-4b33-abb4-af31c6f9d2ec (2025-09-20 02:55Z) -->

# App password prompt bug discussion (2025-09-20 02:55Z)

_**User (2025-09-20 01:34Z)**_

@BookReaderApp.swift 如果有密码，进入App时，则再密码输入框上方提示：请输入6位数字密码。但是有个bug，当将app置于后台，再切换回来时，这个提示就消失了。如果输入了错误的密码，则又显示了

---

_**Assistant (gpt-5)**_

<think><details><summary>Thought Process</summary>**Investigating authentication issues**

I’m considering whether the authenticate function isn't being called correctly, possibly due to isAuthenticating being true. I think that at the time of activation, isAuthenticating might actually be stale. It seems like isAuthenticating only gets set when authenticate is called. Before the app goes into the background, isAuthenticating is likely false. When it checks conditions like PasscodeManager.shared.isPasscodeSet and !isUnlocked, it calls self.authenticate() and sets a message. However, the user claims the prompt disappears when they switch back. Maybe there's a timing issue here regarding the overlay display.
**Examining overlay behavior**

I'm exploring the transition back to active when scenePhase becomes active but isUnlocked is still false. During this, the overlay remains visible. I'm wondering if the message might be hidden when isUnlocked toggles. The user reported that the prompt disappears, which could indicate that the message variable is being set to nil somewhere. It might happen in SecurityOverlayView's onChange when isUnlocked changes, but they don't actually modify message there. However, it seems the parent onChange for scenePhase calls dismissAllModals(), which could notify other watchers.
**Considering message visibility**

I'm thinking that perhaps the view is reconstructing with the message defaulting to nil, and since authenticate hasn't run yet, the overlay shows up while the message remains nil. The user mentioned that "the prompt disappears" when switching back, but if they enter a wrong passcode, onVerify sets authErrorMessage, making the message no longer nil. It seems we should ensure the message is always displayed when the overlay is visible, not just relying on authenticate. We might consider setting a default message when the overlay shows and message is nil.
**Implementing fallback messages**

I’m considering how we can improve the display of messages in the `.onChange(of: scenePhase)`, particularly when it switches to background. We could set `authErrorMessage` to a localized string and also manage the message in `.onChange(of: isUnlocked)`. A better approach might be to drive the message from isUnlocked, showing a default message when locked and no specific message is set. 

In the SecurityOverlayView, I'm thinking of replacing the current message display with a fallback for when the message is empty, to ensure users always see a prompt for entering the passcode.
**Refining message handling**

I'm considering an alternative approach where we set the default authErrorMessage in the `.onChange` for scenePhase to background or active. However, it feels easier to handle this within the overlay. My plan is to compute `let displayMessage = (message?.isEmpty == false) ? message! : String(localized: "security.input_6_digital_passcode")` and display that as `Text(displayMessage)`. 

This way, it’ll always show the message unless a successful unlock occurs. We’re also remembering that the error message should override when necessary without relying on inline comments. Next steps involve refactoring the SecurityOverlayView and ensuring to follow the workspace rules for Git commit messages as needed. I'll implement the changes while maintaining code style and indentation and prepare the patch.</details></think>

---

我将更新 `SecurityOverlayView`，为提示文案增加一个默认回退：当没有特定错误信息时，始终显示“请输入6位数字密码”。这样在应用从后台返回且未解锁时，即使 `authErrorMessage` 为空，也会显示提示。我现在进行代码编辑。

---

Tool use: **apply_patch**

<details>
        <summary>Apply patch for /Users/zgia/program/book/BookReader/BookReader/BookReaderApp.swift</summary>
      

```diff
*** Begin Patch
*** Update File: /Users/zgia/program/book/BookReader/BookReader/BookReaderApp.swift
@@
 private struct SecurityOverlayView: View {
     var showBlur: Bool
     var isUnlocked: Bool
     var message: String?
     var onVerify: (String) -> Void
 
     @State private var input: String = ""
     @FocusState private var isFieldFocused: Bool
+
+    private var displayMessage: String {
+        if let message, !message.isEmpty {
+            return message
+        }
+        return String(localized: "security.input_6_digital_passcode")
+    }
@@
                     Text(String(localized: "security.auth_to_unlock"))
                         .foregroundColor(.black)
                         .font(.headline)
-                    if let message = message, !message.isEmpty {
-                        Text(message)
-                            .foregroundColor(.black.opacity(0.6))
-                            .font(.subheadline)
-                            .multilineTextAlignment(.center)
-                            .padding(.horizontal)
-                    }
+                    Text(displayMessage)
+                        .foregroundColor(.black.opacity(0.6))
+                        .font(.subheadline)
+                        .multilineTextAlignment(.center)
+                        .padding(.horizontal)
                     VStack(spacing: 10) {
                         SecureField(
                             String(
                                 localized: "security.input_6_digital_passcode"
                             ),
*** End Patch
```

---



---

